<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Lista de Créditos</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>
<body>
<header>
    <h1>Lista de Créditos</h1>
</header>

<main>
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-container">
          {% for category, msg in messages %}
            <div class="flash {{ category }}">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="actions">
        <a href="{{ url_for('add_credit') }}" class="button add-credit">Agregar crédito</a>
    </div>

    <section class="table-section">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Fecha</th>
                    <th>Cliente</th>
                    <th>Monto</th>
                    <th>Tasa (%)</th>
                    <th>Plazo (meses)</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for c in creditos %}
                <tr>
                    <td>{{ c.id }}</td>
                    <td>{{ c.fecha_otorgamiento }}</td>
                    <td>{{ c.cliente }}</td>
                    <td>${{ "%.2f"|format(c.monto) }}</td>
                    <td>{{ c.tasa_interes }}%</td>
                    <td>{{ c.plazo }}</td>
                    <td>
                        <div class="actions-btns">
                            <a href="{{ url_for('edit_credit', id=c.id) }}" class="edit">Editar</a>
                            <form action="{{ url_for('delete_credit', id=c.id) }}" method="POST" onsubmit="return confirm('¿Eliminar el crédito ID {{ c.id }}?');">
                                <button type="submit" class="delete">Eliminar</button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7">No hay créditos registrados.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>

    <section class="chart-section">
        <h2>Gráfica de créditos por cliente</h2>
        <canvas id="barChart" data-clientes='{{ clientes|tojson }}' data-montos='{{ montos|tojson }}'></canvas>

        <h2>Distribución de créditos</h2>
        <div class="pie-wrap">
            <canvas id="pieChart" class="pieChartSmall"></canvas>
        </div>

        <script id="pie-data" type="application/json">
            {{ {'labels': rangos, 'data': rango_montos} | tojson }}
        </script>
    </section>

</main>

<!--  CLIENTE ACTIVO -->
<div class="modal" id="activeClientModal">
    <div class="modal-content">
        <p>El cliente ya tiene un crédito activo</p>
        <button id="acceptModal">Aceptar</button>
    </div>
</div>

<script src="{{ url_for('static', filename='script/chart.js') }}"></script>
</body>
</html>
